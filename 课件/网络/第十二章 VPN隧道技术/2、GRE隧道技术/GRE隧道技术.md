# **GRE隧道技术**

## GRE简介

**通用路由封装协议GRE**(Generic Routing Encapsulation)提供了将一种协议的报文封装在另一种协议报文中的机制，**是一种隧道封装技术**。GRE可以封装**任何网络层协议，包括组播数据**，这样就可以保证路由协议、音频、视频流量通过GRE隧道进行传输，**GRE可以解决异种网络的传输问题**。

**GRE本身并不支持加密， 因而通过GRE隧道传输的流量是不加密的**。 将**IPSec技术与GRE结合使用**， **先建立GRE隧道对报文进行GRE封装**，然后再建立**IPSec隧道**对报文进行加密， **以保证报文传输的完整性和私密性。**



![wps1](E:\班里\网络基础\网络基础整理与答案\第十二章 VPN隧道技术-day6\images\wps1.png)

GRE封装报文时，**封装前**的报文**称为净荷**，**封装前**的报文协议称为**乘客协议**，然后GRE 会封装**GRE头部**，GRE成为封装协议，也叫**运载协议**，最后负责对封装后的报文进行转发的协议称为传输协议。



## GRE封装和解封装报文的过程如下：

**1**、设备从连接私网的接口接收到报文后，检查报文头中的目的IP地址字段，在**路由表查找**出接口，**如果发现出接口是隧道接口，则将报文发送给隧道模块进行处理。**

**2**、隧道模块接收到报文后首先**根据乘客协议的类型和当前GRE隧道配置的校验和参数**，对**报文**进行**GRE封装，即添加GRE报文头。**

**3**、然后，设备给报文添加**传输协议报文头**，**即IP报文头**。该IP报文头的**源地址**就是**隧道源地址**，**目的地址**就是**隧道目的地址**。

**4**、**最后**，设备根据**新添加的IP报文头目的地址**，在路由表中查找相应的出接口，并发送报文。之后，封装后的报文将在公网中传输。

**5**、接收端设备从连接公网的接口**收到报文后**， 首先**分析IP报文头**， 如果**发现协议类型字段的值为47**， 表示**协议为GRE**， 于是出接口将报文**交给GRE模块处理。 GRE模块去掉IP报文头和GRE报文头**， 并根据GRE报文头的协议类型字段， **发现此报文的乘客协议为私网中运行的协议， 于是将报文交给该协议处理**。

关键字（Key） 验证是**指对隧道接口进行校验**，这种安全机制可以防止错误接收到来自其他设备的报文。关键字字段是一个四字节长的数值，若GRE报文头中的K位为1，则在 GRE报文头中会插入关键字字段。**只有隧道两端设置的关键字完全一致时才能通过验证，否则报文将被丢弃。**



![wps2](E:\班里\网络基础\网络基础整理与答案\第十二章 VPN隧道技术-day6\images\wps2.png)

**Keepalive(心跳)检测功能用于在任意时刻检测隧道链路是否处于Keepalive状态， 即检测隧道对端是否可达。 如果对端不可达， 隧道连接就会及时关闭， 避免形成数据空洞**。 使能Keepalive检测功能后， GRE隧道本端会定期向对端发送Keepalive探测报文。 若对端可达， 则本端会收到对端的回应报文；若对端不可达， 则收不到对端的回应报文。 如果在隧道一端配置了Keepalive功能， 无论对端是否配置Keepalive， 配置的Keepalive功能在该端都生效。 隧道对端收到Keepalive探测报文， 无论是否配置Keepalive， 都会给源端发送一个回应报文。

**使能Keepalive检测功能后， GRE隧道的源端会创建一个计数器**，并**周期性**地**发送Keepalive探测报文**， **同时进行不可达计数**。**每发送一个探测报文，不可达计数加1**。**如果**源端在**计数器值达到预先设置的值**之前收到回应报文，则**表明对端可达**。如果**计数器值达到预先设置的重试次数，** 源端还是没有**收到回应报文**，则**认为对端不可达。此时，源端将关闭隧道连接。**

 

# **课后练习题：**

1、GRE隧道技术是处于TCP/IP哪个层次的协议？它支持加密吗？

2、GRE协议的协议号是多少？

3、GRE的Keepalive检测功能必须在隧道两端都开启吗？

 

 

 