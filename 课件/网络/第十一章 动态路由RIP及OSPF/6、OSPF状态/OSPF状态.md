# **OSPF状态**

**建立邻接关系，形成统一的链路状态数据库，是OSPF成功生成路由表的关键部分。OSPF在建立邻居何邻接关系时，经过了很多状态。**

**邻居（Neighbor）和邻接（Adjacency）**关系建立的过程如下：

**\1. Down**：这是**邻居的初始状态**， **表示没有在邻居失效时间间隔内收到来自邻居路由器的Hello数据包**。

**\2. Attempt**：此状态**只在NBMA网络上存在**， 表示没有收到邻居的任何信息， 但是已经周期性的向邻居发送报文， **发送间隔为HelloInterval**。如果RouterDeadInterval间隔内未收到邻居的Hello报文， 则转为Down状态。

**\3. Init**：在此状态下， 路由器已经从邻居收到了Hello报文， 但是自己不在所收到的Hello报文的邻居列表中， 尚未与邻居建立双向通信关系。

**\4. 2-Way**：在此状态下， 双向通信已经建立， 但是没有与邻居建立邻接关系。 这是建立邻接关系以前的最高级状态。

**\5. ExStart**：这是形成邻接关系的第一个步骤， 邻居状态变成此状态以后， 路由器开始向邻居发送DD报文。 主从关系是在此状态下形成的，初始DD序列号也是在此状态下决定的。 在此状态下发送的DD报文不包含链路状态描述。

**\6. Exchange：**此状态下路由器相互发送包含链路状态信息摘要的DD报文， 描述本地LSDB的内容。

**\7. Loading**：相互发送LSR报文请求LSA， 发送LSU报文通告LSA。

**\8. Full**：路由器的LSDB已经同步。

**最后稳定的状态应该是2-way状态和Full状态。**

![wps1](E:\班里\网络基础\网络基础整理与答案\第十一章 动态路由RIP及OSPF-day5\images\wps1.png) 

**Router ID是一个32位的值， 它唯一标识了一个自治系统内的路由器**， 管理员可以为每台运行OSPF的路由器手动配置一个Router ID。 如果未手动指定， 设备会按照以下规则自动选举Router ID： 如果设备存在多个逻辑接口地址， 则路由器使用逻辑接口中最大的



# Router ID

IP地址作为Router ID；如果**没有配置逻辑接口**， 则路由器使用物理接口的最大IP地址作为Router ID。 在为一台运行OSPF的路由器配置新的Router ID后， 可以在路由器上通过重置OSPF进程来更新Router ID。 通常**建议手动**配置Router ID，**以防止Router ID因为接口地址的变化而改变**。

OSPF的邻居发现过程是基于Hello报文来实现的，Hello报文中的重要字段解释如下：

**\1. Network Mask**：发送Hello报文的接口的网络掩码。

**\2. Hello Interval**：发送Hello报文的时间间隔， 单位为秒。

**\3. Options**：标识发送此报文的OSPF路由器所支持的可选功能。 具体的可选功能已超出这里的讨论范围。

**\4. Router Priority**：发送Hello报文的接口的Router Priority， 用于选举DR和BDR。

**\5. Router Dead Interval**：失效时间。 如果在此时间内未收到邻居发来的Hello报文， 则认为邻居失效 ；单位为秒， 通常为四倍Hello Interval。

**\6. Designated Router**：发送Hello报文的路由器所选举出的DR的IP地址。 如果设置为0.0.0.0， 表示未选举DR路由器。

**\7. Backup Designated Router**：发送Hello报文的路由器所选举出的BDR的IP地址。如果设置为0.0.0.0， 表示未选举BDR。

**\8. Neighbor**：邻居的Router ID列表， 表示本路由器已经从这些邻居收到了合法的Hello报文。



# Hello报文

如果路由器发现所接收的合法Hello报文的邻居列表中有自己的Router ID，则认为已经和邻居建立了双向连接，表示邻居关系已经建立。验证一个接收到的Hello报文是否合法包括：

1、如果接收端口的网络类型是广播型，点到多点或者NBMA，所接收的Hello报文中Network Mask字段必须和接收端口的网络掩码一致，如果接收端口的网络类型为点到点类型或者是虚连接，则不检查Network Mask字段；

2、所接收的Hello报文中Hello Interval字段必须和接收端口的配置一致；

3、所接收的Hello报文中Router Dead Interval字段必须和接收端口的配置一致；

4、所接收的Hello报文中Options字段中的E-bit（表示是否接收外部路由信息）必须和相关区域的配置一致。

5、如果启用了认证，认证方式和认证数据也要一致。

6、区域ID必须要一致



![wps2](E:\班里\网络基础\网络基础整理与答案\第十一章 动态路由RIP及OSPF-day5\images\wps2.png) 



# 路由器建立完成后数据库同步

路由器在建立完成邻居关系之后， 便开始进行数据库同步，具体过程如下：

**\1.** **邻居状态变为ExStart**以后， **RTA向RTB发送第一个DD报文**， 在这个报文中， **DD 序列号被设置为X**（假设） ， **RTA宣告自己为主路由器**。

**\2.** **RTB**也向**RTA**发送**第一个DD报文**， 在这个报文中， **DD序列号被设置为Y**（假设）

**。 RTB也宣告自己为主路由器。 由于RTB的Router ID比RTA的大， 所以RTB应当为真正的主路由器。**

**\3**. RTA发送一个**新的DD报文**， 在这个新的报文中**包含LSDB的摘要信息**， 序列号设置为RTB在步骤2里使用的序列号， 因此**RTB将邻居状态改变为Exchange。**

**\4**. 邻居状态**变为Exchange以后**， RTB**发送**一个**新的DD报文**， 该报文中**包含LSDB的描述信息**， DD序列号设为**Y+1**（上次使用的序列号加1） 。

**\5**. 即使RTA不需要新的DD报文描述自己的LSDB， 但是作为从路由器，**RTA需要对主路由器RTB发送的每一个DD报文进行确认**。 所以，RTA向RTB发送一个内容为空的DD 报文， 序列号为Y+1。



|      |                                                              |
| ---- | ------------------------------------------------------------ |
|      | ![wps3](E:\班里\网络基础\网络基础整理与答案\第十一章 动态路由RIP及OSPF-day5\images\wps3.png) |

**发送完**最后一个DD报文之后， **RTA将邻居状态改变为Loading； RTB**收到最后一个DD报文之后， 改变状态为**Full**（假设RTB的LSDB是最新最全的， 不需要向RTA请求更新） 。



**\6**. 邻居状态变为**Loading之后**， **RTA开始向RTB发送LSR报文**， 请求那些在**Exchange** 状态下通过DD报文发现的， 而且在本地LSDB中没有的链路状态信息。

**\7**. RTB收到LSR报文之后， 向RTA发送LSU报文， 在LSU报文中， 包含了那些被请求的链路状态的详细信息。 **RTA**收到**LSU**报文之后，将邻居状态**从Loading改变成Full**。

**\8**. RTA向RTB发送LSACK报文， 用于对已接收LSA的确认。



|      |                                                              |
| ---- | ------------------------------------------------------------ |
|      | ![wps4](E:\班里\网络基础\网络基础整理与答案\第十一章 动态路由RIP及OSPF-day5\images\wps4.png) |

此时， RTA和RTB之间的邻居状态变成Full， 表示达到完全邻接状态。

 

# **课后练习题：**

1、简单描述OSPF的full状态形成过程

2、HELLO报文主要作用都有哪些？

3、HELLO报文进行检查时，都检查哪些字段？

4、邻居关系和邻接关系有何不同？