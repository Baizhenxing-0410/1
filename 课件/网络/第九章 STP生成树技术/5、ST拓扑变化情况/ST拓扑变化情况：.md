# **ST拓扑变化情况：**

本节内容主要是来讲解生成树是如何收敛，然后完成故障切换的





##  根桥故障

**1、根桥故障**。非根网桥会在BPDU老化时间超时后**开始根桥的重新选举**



 ![a (1)](E:\班里\网络基础\网络基础整理与答案\第九章 STP生成树技术-day4\images\a (1).png)



在稳定的STP拓扑里， 非根桥会定期收到来自根桥的BPDU报文。 **如果根桥发生了故障， 停止发送BPDU报文， 下游交换机就无法收到来自根桥的BPDU报文**。 如果下游交换机一直**收不到**BPDU报文， Max Age定时器就会超时（ Max Age的默认值为**20**秒） ， **从而导致已经收到的BPDU报文失效**， 此时， **非根交换机**会**互相**发送配置BPDU报文， **重新选举新的根桥**。 **根桥故障会导致50秒左右的恢复时间**， 恢复时间**约等于Max Age加上两倍的Forward Delay收敛时间。**





## 直连链路故障

2、**直连链路故障**。**SWB检测到直连链路物理故障后，会将预备端口转换为根端口，新的根端口会在30秒后恢复到转发状态

![a (2)](E:\班里\网络基础\网络基础整理与答案\第九章 STP生成树技术-day4\images\a (2).png)

SWA和SWB使用了**两条链路互连**， 其中一条是**主用链路**， 另外一条是**备份链路**。 生成树正常收敛之后， 如果SWB检测到根端口的链路**发生物理故障**， 则其Alternate端口**会迁移到**Listening、 Learning、Forwarding状态， **经过两倍的Forward Delay后恢复到转发状态**。





## 非直连链路出现故障

**3、非直连链路出现故障。**SWC的预备端口恢复到转发状态大约需要50秒

![a (3)](E:\班里\网络基础\网络基础整理与答案\第九章 STP生成树技术-day4\images\a (3).png)

SWB与SWA之间的链路**发生了某种故障（非物理层故障**） ，**SWB**因此**一直收不到来自SWA**的**BPDU报文**。 **等待Max Age定时器超时后**， **SWB会认为根桥SWA不再有效**， **并认为自己是根桥， 于是开始发送自己的BPDU报文给SWC， 通知SWC自己作为新的根桥**。在此期间，由于SWC的Alternate端口再也不能收到包含原根桥ID的BPDU报文。 其Max Age定时器超时后， SWC会切换Alternate端口为指定端口并且转发来自其根端口的BPDU 报文给SWB。 所以， Max Age定时器超时后，**SWB、 SWC几乎同时会收到对方发来的BPDU。 经过STP重新计算后，SWB放弃宣称自己是根桥并重新确定端口角色。** 非直连链路故障后， 由于需要**等待Max Age加上两倍的Forward Delay时间**， **端口需要大约50秒才能恢复到转发状态。**

 



### 拓扑改变致MAC产生错误



**4、拓扑改变会导致MAC地址表产生错误**。

![img](file:///C:\Users\ZH-PC\AppData\Local\Temp\ksohtml6344\wps4.png) 

**MAC地址表的默认老化时间是300秒，在这段时间内，SWB无法将数据从G0/0/2端口转发给主机B。那么如何来解决这个问题呢？**

拓扑变化过程中， 根桥通过TCN BPDU报文获知生成树拓扑里发生了故障。 根桥生成TC用来通知其他交换机加速老化现有的MAC地址表项。拓扑变更以及MAC地址表项更新的具体



### 过程如下：

**\1.** SWC感知到网络拓扑发生变化后， 会不间断地向SWB发送TCNBPDU报文。

**\2**. SWB收到SWC发来的TCN BPDU报文后， 会把配置BPDU报文中的Flags的TCA位设置1， 然后发送给SWC， 告知SWC停止发送TCN BPDU报文。

**\3**. SWB向根桥转发TCN BPDU报文。

**\4**. SWA把配置BPDU报文中的Flags的TC位设置为1后发送， 通知下游设备把MAC地址表项老化时间由默认的300秒修改为Forward

Delay的时间（默认为15秒） 。

**\5.** 最多等待15秒之后， SWB中的错误MAC地址表项会被自动清除。 此后， SWB就能重新开始MAC表项的学习及转发操作。

 

# **课后练习题：**

1、如果根网桥出现故障，传统STP收敛完成，最多需要多久？

2、如果直连根网桥链路物理故障，传统STP收敛完成，最多需要多久？

3、传统生成树协议如何解决MAC地址表刷新问题？